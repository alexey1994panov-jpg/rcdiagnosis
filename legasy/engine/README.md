# Варианты ЛЗ и ЛС (1P)

Этот модуль описывает детекторы логической занятости (ЛЗ) и логической ложной свободности (ЛС) для направления 1P на станции «Visochino». Файлы сгруппированы по типу: варианты ЛЗ, варианты ЛС, общая логика и исключения.

## Структура файлов

- `variant1_1p.py` – детектор ЛЗ, вариант 1.  
- `variant2_1p.py` – детектор ЛЗ, вариант 2.  
- `variant3_1p.py` – детектор ЛЗ, вариант 3.  
- `variant4_1p.py` – детектор ЛЗ, вариант 4.  
- `variant5_1p.py` – детектор ЛЗ, вариант 5.  
- `variant6_1p.py` – детектор ЛЗ, вариант 6.  
- `variant7_1p.py` – детектор ЛЗ, вариант 7.  
- `variant8_1p.py` – детектор ЛЗ, вариант 8 (манёвровый).  
- `variant9_1p.py` – детектор ЛЗ, вариант 9.  
- `variant10_1p.py` – детектор ЛЗ, вариант 10.  
- `variant11_1p.py` – детектор ЛЗ, вариант 11.  
- `variant12_1p.py` – детектор ЛЗ, вариант 12.  
- `variant13_1p.py` – детектор ЛЗ, вариант 13. 

- `ls_variant1_1p.py` – детектор ЛС, вариант 1.  
- `ls_variant2_1p.py` – детектор ЛС, вариант 2.  
- `ls_variant4_1p.py` – детектор ЛС, вариант 4.  
- `ls_variant9_1p.py` – детектор ЛС, вариант 9.  

- `common_1p.py` – общие вспомогательные функции и проверки.  
- `detectors_runner_1p.py` – инициализация и запуск всех детекторов на каждом шаге.  
- `flags_1p.py` – описания флагов ЛЗ/ЛС и диагностических флагов таймлайна.  
- `station_visochino_1p.py` – модель станции и конфигурация РЦ/стрелок/смежных путей.  
- `adjacency_1p.py` – логика определения смежных РЦ и контроль «краёв» участка с учётом ТПК. 
- `types_1p.py` – типы входных шагов сценария.  
- `simulate_1p.py` – главный цикл симуляции, сбор таймлайна и применение исключений.  
- `config_1p.py` – константы времени и `VariantOptions` с параметрами вариантов и исключений.  

## Общая идея

Каждый вариант ЛЗ/ЛС реализован как отдельный детектор, работающий на последовательности шагов сценария. Детекторы используют:

- состояния РЦ и стрелок из `ScenarioStep` (`types_1p.py`);
- конфигурацию станции (`station_visochino_1p.py`);
- параметры времени и паузы из `VariantOptions` (`config_1p.py`);
- общие функции из `common_1p.py`;
- флаги смежности `prev_control_ok` / `next_control_ok`, которые формируются в `simulate_1p.py` с помощью `update_adjacency(...)` и выдержки ТПК (`T_PK`) для выбранной контролируемой РЦ (`ctrl_rc_id`). 

Результат работы детекторов – флаги вида `llz_v*` и `lls_v*`, которые записываются в `TimelineStep` (`simulate_1p.py`) и затем отображаются во фронтенде.

## Варианты ЛЗ

Варианты ЛЗ используют разные комбинации интервалов и условий по состояниям РЦ.

### `variant1_1p.py` — ЛЗ v1

- Параметры:
  - `t_s0101` – минимальное время пребывания в структуре `0–1–0` (C0101).
  - `t_lz01` – минимальное время ЛЗ после выполнения C0101.
  - `t_kon_v1` – время контроля окончания занятости после ЛЗ.
  - `t_pause_v1` – пауза после окончания ЛЗ до повторного срабатывания.
- Флаги:
  - `llz_v1` – ЛЗ активна.
  - `llz_v1_open` – момент открытия ЛЗ.
  - `llz_v1_closed` – момент закрытия ЛЗ.

### `variant2_1p.py` — ЛЗ v2

- Двухфазный вариант: сначала движение по структуре S0102, затем по S0202.
- Параметры:
  - `t_s0102`, `t_s0202`, `t_lz02`, `t_kon_v2`, `t_pause_v2`.
- Флаги:
  - `llz_v2`, `llz_v2_open`, `llz_v2_closed` и диагностические флаги.

### `variant3_1p.py` — ЛЗ v3

- Аналогично v2, но со своими временными параметрами (другой профиль работы).
- Параметры: `t_s0103`, `t_s0203`, `t_lz03`, `t_kon_v3`, `t_pause_v3`.
- Флаги: `llz_v3*`.

### `variant4_1p.py` — ЛЗ v4

- Фиксирует ложную занятость контролируемой РЦ при закрытом входном/выходном светофоре и отсутствии контроля одной из смежных РЦ (предыдущей или следующей). 
- Работает по трём РЦ: `prev_rc_id`, `ctrl_rc_id`, `next_rc_id` и использует флаги смежности `prev_control_ok`/`next_control_ok`, формируемые через `update_adjacency(...)`, чтобы различать нормальный сосед и край участка (NC). 
- Содержит две ветки:
  - 4.1 — «предыдущая без контроля, входной поездной закрыт»;
  - 4.2 — «следующая без контроля, выходной маневровый закрыт».
- Параметры: `t_s0401`, `t_lz04`, `t_kon_v4`, `t_pause_v4`.
- Флаги: `llz_v4`, `llz_v4_open`, `llz_v4_closed`.

### `variant8_1p.py` — ЛЗ v8 (манёвровый вариант)

- Вариант для манёвровых режимов и сложных сценариев.
- Параметры: `t_s0108`, `t_s0208`, `t_lz08`, `t_kon_v8`, `t_pause_v8`.
- Флаги: `llz_v8*`.
- При расчёте ЛЗ v8 дополнительно учитываются:
  - режим ДСП и состояние автодействий;
  - минимальное время манёвровой работы `t_min_maneuver_v8`, используемое исключениями.

*(Аналогично v1–v4 и v8 реализованы варианты v5, v6, v7, v9, v10, v11, v12 и v13; каждый детектор имеет свой набор временных параметров `t_s*`, `t_lz*`, `t_kon_v*`, `t_pause_v*` и работает по конфигурации станции с выбранной контролируемой РЦ и смежными участками.)* 

## Варианты ЛС

Варианты ЛС используют события ЛЗ, состояний РЦ и смежных путей для поиска ложной свободности.

### `ls_variant1_1p.py` — ЛС v1

- Параметры:
  - `t_c0101_ls` – длительность структуры C0101 для ЛС.
  - `t_ls01` – минимальное время ЛС.
  - `t_kon_ls1` – время контроля после ЛС.
  - `t_pause_ls1` – пауза после ЛС.
- Флаги:
  - `lls_v1`, `lls_v1_open`, `lls_v1_closed`.

### `ls_variant2_1p.py` — ЛС v2

- Двухфазный вариант для более сложных сценариев.
- Параметры:
  - `t_s0102_ls`, `t_s0202_ls` – интервальные условия.
  - `t_ls0102`, `t_ls0202` – времена ЛС по фазам.
  - `t_kon_ls2`, `t_pause_ls2`.
- Флаги: `lls_v2*`.

### `ls_variant4_1p.py` — ЛС v4

- Вариант, учитывающий расширенную конфигурацию РЦ/смежных путей.
- Параметры: `t_s0104_ls`, `t_s0204_ls`, `t_ls0104`, `t_ls0204`, `t_kon_ls4`, `t_pause_ls4`.
- Флаги: `lls_v4*`.

### `ls_variant9_1p.py` — ЛС v9

- Упрощённый вариант без использования смежных путей.
- Параметры: `t_s0109_ls`, `t_s0209_ls`, `t_ls0109`, `t_ls0209`, `t_kon_ls9`, `t_pause_ls9`.
- Флаги: `lls_v9*`.

## Детекторы и таймлайн

Работа детекторов не вызывается напрямую. Вместо этого:

1. В `simulate_1p.py` из входного словаря `options` строится `VariantOptions`.
2. Функция `init_detectors(...)` в `detectors_runner_1p.py` создаёт экземпляры всех детекторов ЛЗ и ЛС.
3. На каждом шаге:
   - сначала вызывается `update_adjacency(...)`, вычисляются `effective_prev_rc/effective_next_rc` и флаги `prev_control_ok`/`next_control_ok` для текущей контролируемой РЦ и записываются в `step.modes`; 
   - затем вызывается `run_detectors(...)`, который:
     - передаёт текущий `ScenarioStep` всем детекторам;
     - собирает результаты по вариантам;
     - обновляет диагностические флаги и состояние.
   - Результаты вписываются в `TimelineStep`:
     - текущие состояния РЦ/стрелок;
     - состояние ЛЗ/ЛС по каждому варианту;
     - списки флагов `flags` для дальнейшего анализа и визуализации.

## Совместимость и изменения

- Временные параметры и включение/выключение вариантов ЛЗ/ЛС задаются на уровне `VariantOptions` и HTTP‑API (`/defaults`, `/simulate`). 
- Все изменения логики вариантов должны:
  - сохранять существующие имена параметров и флагов;
  - не менять формат таймлайна (`TimelineStep`) без отдельного решения.
- Новые варианты ЛЗ/ЛС рекомендуется добавлять отдельными модулями `variantX_1p.py` / `ls_variantX_1p.py` и включать их в `detectors_runner_1p.py` через новый блок конфигурации.