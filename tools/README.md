# РРЅСЃС‚СЂСѓРјРµРЅС‚С‹ RC Diagnosis

РћР±РЅРѕРІР»РµРЅРѕ: 2026-02-11

Р­С‚Р° РїР°РїРєР° СЃРѕРґРµСЂР¶РёС‚ С‚РµРєСѓС‰РёР№ РґРІРёР¶РѕРє РґРµС‚РµРєС‚РѕСЂРѕРІ (РІР°СЂРёР°РЅС‚С‹ Р›Р—/Р›РЎ), РєР°РЅРѕРЅРёС‡РµСЃРєРёР№ СЂРµРµСЃС‚СЂ РјР°СЃРѕРє, СЂР°РЅС‚Р°Р№Рј СЃРёРјСѓР»СЏС†РёРё Рё С‚РµСЃС‚С‹. РќР° 2026-02-11 РєРѕРґ СЂР°Р·РґРµР»РµРЅ РЅР° РїРѕРґРїР°РєРµС‚С‹, Р° РІ `tools/*.py` РѕСЃС‚Р°РІР»РµРЅС‹ СЃРѕРІРјРµСЃС‚РёРјС‹Рµ С€РёРјРё.

## РћР±Р»Р°СЃС‚СЊ РѕС‚РІРµС‚СЃС‚РІРµРЅРЅРѕСЃС‚Рё
- РСЃС‚РѕС‡РЅРёРє РїСЂР°РІРґС‹ РґР»СЏ СЂР°РЅС‚Р°Р№РјР° Рё С‚РµСЃС‚РѕРІ вЂ” `tools/`.
- `legasy/` РёСЃРїРѕР»СЊР·СѓРµС‚СЃСЏ С‚РѕР»СЊРєРѕ РєР°Рє СЃРїСЂР°РІРѕС‡РЅС‹Р№ Р°СЂС…РёРІ Рё РёСЃРєР»СЋС‡РµРЅ РёР· СЃС‚Р°РЅРґР°СЂС‚РЅРѕРіРѕ `pytest`-РїРѕРёСЃРєР°.
- Р’ `pytest.ini` РёСЃРїРѕР»СЊР·СѓРµС‚СЃСЏ:
  - `testpaths = tools`

## Р‘С‹СЃС‚СЂС‹Р№ СЃС‚Р°СЂС‚
- Р—Р°РїСѓСЃС‚РёС‚СЊ РІСЃРµ С‚РµСЃС‚С‹ РґРµС‚РµРєС‚РѕСЂРѕРІ:
```powershell
python -m pytest -q
```
- РџСЂРѕРІРµСЂРёС‚СЊ РєРѕРјРїРёР»СЏС†РёСЋ РєР»СЋС‡РµРІС‹С… РјРѕРґСѓР»РµР№:
```powershell
python -m py_compile tools/core/variants_common.py tools/core/detectors_engine.py
```

## РђСЂС…РёС‚РµРєС‚СѓСЂР°
- `detectors_engine.py`: Р¶РёР·РЅРµРЅРЅС‹Р№ С†РёРєР» РґРµС‚РµРєС‚РѕСЂРѕРІ, dataclass-РєРѕРЅС„РёРіРё/СЃРѕСЃС‚РѕСЏРЅРёСЏ/СЂРµР·СѓР»СЊС‚Р°С‚С‹, С†РёРєР» РѕР±РЅРѕРІР»РµРЅРёСЏ.
- `variants_common.py`: РєР°РЅРѕРЅРёС‡РµСЃРєРёРµ РјР°СЃРєРё, РїСЂРµРґРёРєР°С‚С‹, `get_mask_by_id`, `mask_to_string`.
- `variant*_lz_factory.py`, `variant*_ls_factory.py`: С„Р°Р·РѕРІР°СЏ Р»РѕРіРёРєР° РїРѕ РІР°СЂРёР°РЅС‚Р°Рј.
- `flags_engine.py`: СЂР°СЃС‡РµС‚ active/open/closed С„Р»Р°РіРѕРІ Рё РёС‚РѕРіРѕРІРѕРіРѕ РІР°СЂРёР°РЅС‚Р°.
- `sim_core.py`: РёСЃРїРѕР»РЅРµРЅРёРµ СЃС†РµРЅР°СЂРёСЏ Рё С„РѕСЂРјРёСЂРѕРІР°РЅРёРµ С‚Р°Р№РјР»Р°Р№РЅР°.
- `exceptions_engine.py`: РїРѕСЃС‚РѕР±СЂР°Р±РѕС‚РєР° С„Р»Р°РіРѕРІ Р›Р—/Р›РЎ РїРѕ РёСЃРєР»СЋС‡РµРЅРёСЏРј (MU, РЅРµРґР°РІРЅСЏСЏ РїСЂРѕС‚РёРІРѕРїРѕР»РѕР¶РЅР°СЏ Р”РЎ, DSP timeout).
- `generate_station_from_objects.py`: РіРµРЅРµСЂР°С†РёСЏ `station_config.py`/`station_rc_sections.py` РёР· `xml/Objects.xml` (РІРєР»СЋС‡Р°СЏ РіСЂСѓРїРїСѓ РёРЅРґРёРєР°С‚РѕСЂРѕРІ `1000.9.*`).
  - РўР°РєР¶Рµ С„РѕСЂРјРёСЂСѓРµС‚ `INDICATORS` Рё `INDICATOR_SUBTYPES` РІ `station_config.py`.

## Р РµРµСЃС‚СЂ РІР°СЂРёР°РЅС‚РѕРІ (С‚РµРєСѓС‰РёР№ РєРѕРґ)

### Р’Р°СЂРёР°РЅС‚С‹ Р›Р—
| Р’Р°СЂРёР°РЅС‚ | Р¤Р°Р№Р» | Р¤Р°Р·С‹ | NeighborRequirement | РћСЃРЅРѕРІРЅС‹Рµ РїР°СЂР°РјРµС‚СЂС‹ |
|---|---|---:|---|---|
| LZ1 | `tools/variant1_lz_factory.py` | 2 | `BOTH` | `ts01_lz1`, `tlz_lz1`, `tkon_lz1` |
| LZ2 | `tools/variant2_lz_factory.py` | 3 | `BOTH` | `ts01_lz2`, `ts02_lz2`, `tlz_lz2`, `tkon_lz2` |
| LZ3 | `tools/variant3_lz_factory.py` | 3 | `BOTH` | `ts01_lz3`, `ts02_lz3`, `tlz_lz3`, `tkon_lz3` |
| LZ4 | `tools/variant4_lz_factory.py` | 2 (РїРѕ РІРµС‚РєРµ) | `ONE_NC` | `ts01_lz4`, `tlz_lz4`, `tkon_lz4`, `sig_lz4_prev_to_ctrl`, `sig_lz4_ctrl_to_next` |
| LZ5 | `tools/variant5_lz_factory.py` | 2 | `ONLY_CTRL` | `ts01_lz5`, `tlz_lz5`, `tkon_lz5` |
| LZ6 | `tools/variant6_lz_factory.py` | 2 | `ONLY_CTRL` | `ts01_lz6`, `tlz_lz6`, `tkon_lz6` |
| LZ7 | `tools/variant7_lz_factory.py` | 2 (РїРѕ РІРµС‚РєРµ) | `NONE` | `ts01_lz7`, `tlz_lz7`, `tkon_lz7` |
| LZ8 | `tools/variant8_lz_factory.py` | 3 (РїРѕ РІРµС‚РєРµ) | `BOTH` | `ts01_lz8`, `ts02_lz8`, `tlz_lz8`, `tkon_lz8` |
| LZ9 | `tools/variant_lz9_lz_factory.py` | С‚Р°Р№РјРёРЅРіРѕРІР°СЏ РјР°С€РёРЅР° СЃРѕСЃС‚РѕСЏРЅРёР№ | РєР°СЃС‚РѕРјРЅС‹Р№ РґРµС‚РµРєС‚РѕСЂ | `ts01_lz9`, `tlz_lz9`, `tkon_lz9` |
| LZ10 | `tools/variant_lz10_lz_factory.py` | 4 | `ONLY_CTRL` | `ts01_lz10`, `ts02_lz10`, `ts03_lz10`, `tlz_lz10`, `tkon_lz10`, `sig_lz10_to_next`, `sig_lz10_to_prev` |
| LZ11 | `tools/variant_lz11_lz_factory.py` | 2 | `ONLY_CTRL` | `ts01_lz11`, `tlz_lz11`, `tkon_lz11`, `sig_lz11_a`, `sig_lz11_b` |
| LZ12 | `tools/variant_lz12_lz_factory.py` | 3 (РїРѕ РІРµС‚РєРµ) | `ONE_NC` | `ts01_lz12`, `ts02_lz12`, `tlz_lz12`, `tkon_lz12` |
| LZ13 | `tools/variant_lz13_lz_factory.py` | 3 | `ONE_ADJ` | `ts01_lz13`, `ts02_lz13`, `tlz_lz13`, `tkon_lz13`, `sig_lz13_prev`, `sig_lz13_next` |

### Р’Р°СЂРёР°РЅС‚С‹ Р›РЎ
| Р’Р°СЂРёР°РЅС‚ | Р¤Р°Р№Р» | Р¤Р°Р·С‹ | NeighborRequirement | РћСЃРЅРѕРІРЅС‹Рµ РїР°СЂР°РјРµС‚СЂС‹ |
|---|---|---:|---|---|
| LS1 | `tools/variant_ls1_lz_factory.py` | 2 | `BOTH` | `ts01_ls1`, `tlz_ls1`, `tkon_ls1` |
| LS2 | `tools/variant_ls2_lz_factory.py` | 3 (РїРѕ РІРµС‚РєРµ) | `BOTH` | `ts01_ls2`, `ts02_ls2`, `tlz_ls2`, `tkon_ls2` |
| LS4 | `tools/variant_ls4_lz_factory.py` | 3 | `BOTH` | `ts01_ls4`, `tlz01_ls4`, `tlz02_ls4`, `tkon_ls4` |
| LS5 | `tools/variant_ls5_lz_factory.py` | 2 (РїРѕ РІРµС‚РєРµ) | `BOTH` | `ts01_ls5`, `tlz_ls5`, `tkon_ls5` |
| LS6 | `tools/variant_ls6_lz_factory.py` | 2 | `ONE_NC` | `ts01_ls6`, `tlz_ls6`, `tkon_ls6`, `sig_ls6_prev` |
| LS9 | `tools/variant_ls9_lz_factory.py` | 3 | `ONLY_CTRL` | `ts01_ls9`, `tlz_ls9`, `tkon_ls9` |

## РљР°РЅРѕРЅРёС‡РµСЃРєР°СЏ СЃРёСЃС‚РµРјР° РјР°СЃРѕРє

РљР°РЅРѕРЅРёС‡РµСЃРєРёРµ ID РёСЃРїРѕР»СЊР·СѓСЋС‚СЃСЏ РІ `variants_common.py` (`get_mask_by_id`, `mask_to_string`).

### Р”РёР°РїР°Р·РѕРЅС‹ ID
- РџСЂРѕСЃС‚С‹Рµ RC-РјР°СЃРєРё: `1..`
- РљРѕРјРїРѕР·РёС‚РЅС‹Рµ OR-РјР°СЃРєРё: `100..`
- X/ctrl/lock/nc/signal/timing РјР°СЃРєРё: РІС‹РґРµР»РµРЅРЅС‹Рµ РґРёР°РїР°Р·РѕРЅС‹, СѓР¶Рµ РёСЃРїРѕР»СЊР·СѓРµРјС‹Рµ РІ РєРѕРґРµ.
- РЎРѕС…СЂР°РЅРµРЅ alias РґР»СЏ СЃРѕРІРјРµСЃС‚РёРјРѕСЃС‚Рё: `106 -> 101`.

### РљР°РЅРѕРЅРёС‡РµСЃРєРёРµ РёРјРµРЅР° РІ РєРѕРґРµ
РџСЂРёРјРµСЂС‹:
- `RC_0_0_0`, `RC_0_1_0`, `RC_1_0_1`, `RC_1_1_1`
- `RC_0NL`, `RC_1NL`
- `RC_N_1_0L`, `RC_N_1_1L`, `RC_L0_1_N`, `RC_L1_1_N`
- `RC_CTRL_1__ADJ_FREE_OR_NC`, `RC_CTRL_0__ADJ_OCC`
- `SIG_0_RC_0_SIG_0`, `RC_0_1_0_SIG_1`, `RC_0_1_1_SIG_1`

РџРѕР»РЅС‹Р№ С‡РµСЂРЅРѕРІРёРє Рё РѕР±РѕСЃРЅРѕРІР°РЅРёРµ: `tools/docs/MASK_REGISTRY_DRAFT.md`.

## РљРѕРЅС‚СЂР°РєС‚ С„Р»Р°РіРѕРІ
Р¤Р»Р°РіРё С„РѕСЂРјРёСЂСѓСЋС‚СЃСЏ С‡РµСЂРµР· `detectors_engine.py` + `flags_engine.py`.

### Р›Р—
- Active: `llz_v{N}`
- Open: `llz_v{N}_open`
- Closed: `llz_v{N}_closed`

### Р›РЎ
- Active: `lls_{N}`
- Open: `lls_{N}_open`
- Closed: `lls_{N}_closed`

РџСЂРёРѕСЂРёС‚РµС‚ РІР°СЂРёР°РЅС‚Р° РІ `flags_engine.py` СѓС‡РёС‚С‹РІР°РµС‚ Р°РєС‚РёРІРЅРѕРµ СЃРѕСЃС‚РѕСЏРЅРёРµ РґРµС‚РµРєС‚РѕСЂР° (РїСЂРѕСЃС‚СЂР°РЅСЃС‚РІРѕ LS `100+` РїСЂРёРѕСЂРёС‚РµС‚РЅРµРµ LZ).

## РСЃРєР»СЋС‡РµРЅРёСЏ (Р›Р—/Р›РЎ)

РСЃРєР»СЋС‡РµРЅРёСЏ РєРѕРЅС„РёРіСѓСЂРёСЂСѓСЋС‚СЃСЏ РІ `DetectorsConfig` Рё РїСЂРёРјРµРЅСЏСЋС‚СЃСЏ РІ `sim_core.run()` РєР°Рє РїРѕСЃС‚РѕР±СЂР°Р±РѕС‚РєР°.

- РџРѕРґР°РІР»РµРЅРёСЏ Р›Р—:
  - `enable_lz_exc_mu`, `t_mu`
  - `enable_lz_exc_recent_ls`, `t_recent_ls`
  - `enable_lz_exc_dsp`, `t_min_maneuver_v8`
- РџРѕРґР°РІР»РµРЅРёСЏ Р›РЎ:
  - `enable_ls_exc_mu`, `t_ls_mu`
  - `enable_ls_exc_after_lz`, `t_ls_after_lz`
  - `enable_ls_exc_dsp`, `t_ls_dsp`

Р’СЃРµ С„Р»Р°РіРё РёСЃРєР»СЋС‡РµРЅРёР№ РїРѕ СѓРјРѕР»С‡Р°РЅРёСЋ РІС‹РєР»СЋС‡РµРЅС‹.

### РРЅС‚РµРіСЂР°С†РёСЏ РЅР° СѓСЂРѕРІРЅРµ С„Р°Р· (Р»СЋР±РѕР№ РґРµС‚РµРєС‚РѕСЂ/С„Р°Р·Р°)

`PhaseConfig` РїРѕРґРґРµСЂР¶РёРІР°РµС‚ Р°РІР°СЂРёР№РЅС‹Р№ СЃР±СЂРѕСЃ С„Р°Р·С‹ РїРѕ РєР»СЋС‡Р°Рј РёСЃРєР»СЋС‡РµРЅРёР№:

- `abort_exception_keys: Tuple[str, ...]`
- `reset_on_exception: bool` (РїРѕ СѓРјРѕР»С‡Р°РЅРёСЋ `True`)

РљР»СЋС‡Рё РїСЂРѕР±СЂР°СЃС‹РІР°СЋС‚СЃСЏ РІ `step.modes` РёР· РёСЃС‚РѕСЂРёРё СЂР°РЅС‚Р°Р№РјР° РІ `sim_core`:
- `exc_lz_mu_active`
- `exc_lz_recent_ls`
- `exc_lz_dsp_timeout`
- `exc_lz_dsp_timeout`
- `exc_ls_mu_active`
- `exc_ls_after_lz`
- `exc_ls_dsp_timeout`

РўРµРєСѓС‰РµРµ РёСЃРїРѕР»СЊР·РѕРІР°РЅРёРµ:
- Р¤Р°Р·С‹ `LZ8` Р·Р°С‰РёС‰РµРЅС‹ `exc_lz_dsp_timeout` Рё РїСЂРµСЂС‹РІР°СЋС‚СЃСЏ РґРѕ РѕС‚РєСЂС‹С‚РёСЏ.

### РћР±СЉРµРєС‚РЅС‹Рµ РІС…РѕРґС‹ (`MU/NAS/CHAS/DSP`)

РћР±СЉРµРєС‚С‹-РёСЃС‚РѕС‡РЅРёРєРё РёСЃРєР»СЋС‡РµРЅРёР№ РјРѕР¶РЅРѕ Р·Р°РґР°РІР°С‚СЊ РІ:
- `tools/exceptions_objects.json`

РЎС…РµРјР°:
- `id`: СѓРЅРёРєР°Р»СЊРЅС‹Р№ ID РѕР±СЉРµРєС‚Р° (СЃС‚СЂРѕРєР°)
- `kind`: `MU | NAS | CHAS | DSP`
- `target_rc_ids`: СЃРїРёСЃРѕРє RC ID (`DSP` С‚СЂР°РєС‚СѓРµС‚СЃСЏ РєР°Рє РіР»РѕР±Р°Р»СЊРЅС‹Р№)
- `active_states`: СЃРїРёСЃРѕРє Р°РєС‚РёРІРЅС‹С… state ID

Р Р°РЅС‚Р°Р№Рј:
- РўРµРєСѓС‰РёРµ СЃРѕСЃС‚РѕСЏРЅРёСЏ РѕР±СЉРµРєС‚РѕРІ РїРµСЂРµРґР°СЋС‚СЃСЏ РІ `ScenarioStep.indicator_states` РєР°Рє `{object_id: state}`.
- `sim_core` РјР°РїРїРёС‚ Р°РєС‚РёРІРЅС‹Рµ РѕР±СЉРµРєС‚С‹ РІРѕ РІС…РѕРґС‹ РґРµС‚РµРєС‚РѕСЂРѕРІ:
  - `MU` -> `step.mu[ctrl_rc_id] = 1`
  - `NAS/CHAS` -> `step.auto_actions["nas"/"chas"] = 0`
  - `DSP` -> `step.dispatcher_control_state = 4` (РµСЃР»Рё СЏРІРЅРѕ РЅРµ Р·Р°РґР°РЅРѕ)

РљРѕРЅРІРµРЅС†РёСЏ СЃРѕСЃС‚РѕСЏРЅРёСЏ РёРЅРґРёРєР°С‚РѕСЂРѕРІ РґР»СЏ РѕР±СЉРµРєС‚РѕРІ РёСЃРєР»СЋС‡РµРЅРёР№:
- `3` = РІС‹РєР»СЋС‡РµРЅ (РЅРµР°РєС‚РёРІРµРЅ)
- `6` = РІРєР»СЋС‡РµРЅ (Р°РєС‚РёРІРµРЅ, Р±РµР»С‹Р№)
- РµСЃР»Рё `active_states` РЅРµ СѓРєР°Р·Р°РЅРѕ РІ JSON, РёСЃРїРѕР»СЊР·СѓРµС‚СЃСЏ `[6]`.

### DSP policy (detector-global)

`exceptions_objects.json` РјРѕР¶РµС‚ СЃРѕРґРµСЂР¶Р°С‚СЊ `dsp_policy`:

- `default`
  - `enabled`: bool
  - `mode`: СЃРµР№С‡Р°СЃ `detector_global`
  - `count_scope`: `ctrl_occupied` РёР»Рё `always`
  - `variants`: СЃРїРёСЃРѕРє РЅРѕРјРµСЂРѕРІ РІР°СЂРёР°РЅС‚РѕРІ Р›Р— (РЅР°РїСЂРёРјРµСЂ, `[8]`)
  - `t_maneuver`: РїРѕСЂРѕРі РІ СЃРµРєСѓРЅРґР°С…
- `rc_overrides`: РїРµСЂРµРѕРїСЂРµРґРµР»РµРЅРёСЏ РїРѕ RC ID

РџРѕРІРµРґРµРЅРёРµ:
- РїРѕРєР° DSP Р°РєС‚РёРІРµРЅ Рё Р°РІС‚Рѕ-РґРµР№СЃС‚РІРёСЏ РІС‹РєР»СЋС‡РµРЅС‹ (`0`/`3`), С‚Р°Р№РјРµСЂ РєРѕРїРёС‚СЃСЏ РїРѕ scope policy;
- РїСЂРё РґРѕСЃС‚РёР¶РµРЅРёРё `t_maneuver` РІС‹Р±СЂР°РЅРЅС‹Рµ РІР°СЂРёР°РЅС‚С‹ РґРµС‚РµРєС‚РѕСЂРѕРІ СЃР±СЂР°СЃС‹РІР°СЋС‚СЃСЏ;
- СЃРѕРѕС‚РІРµС‚СЃС‚РІСѓСЋС‰РёРµ С„Р»Р°РіРё `llz_v{N}*` РїРѕРґР°РІР»СЏСЋС‚СЃСЏ Рё РґРѕР±Р°РІР»СЏРµС‚СЃСЏ `lz_suppressed:dsp_detector_gate`.

## РџРµСЂРµРґР°С‡Р° РІРѕ С„СЂРѕРЅС‚РµРЅРґ (СЃС‚Р°СЂС‚)
Р”РѕР±Р°РІР»РµРЅ РґРѕРєСѓРјРµРЅС‚ РїРµСЂРµРґР°С‡Рё РґР»СЏ С„СЂРѕРЅС‚РµРЅРґР°:
- `tools/docs/FRONTEND_HANDOFF.md`

Р’ РЅРµРј РѕРїРёСЃР°РЅС‹:
- С„РѕСЂРјР° payload С‚Р°Р№РјР»Р°Р№РЅР° РёР· `sim_core.TimelineStep`
- РѕР±СЏР·Р°С‚РµР»СЊРЅС‹Рµ РїРѕР»СЏ РґР»СЏ РіСЂР°С„РёРєРѕРІ/СЃС‚Р°С‚СѓСЃРѕРІ
- РјР°РїРїРёРЅРі РІР°СЂРёР°РЅС‚Р° Рё С„Р»Р°РіРѕРІ
- РїРѕСЌС‚Р°РїРЅС‹Р№ РїР»Р°РЅ РёРЅС‚РµРіСЂР°С†РёРё
- DTO layout СЃС‚Р°РЅС†РёРё РґР»СЏ SVG-СЂРµРЅРґРµСЂР° РІРѕ С„СЂРѕРЅС‚РµРЅРґРµ (`GET /station-layout`)

## РџСЂРёРјРµС‡Р°РЅРёСЏ
- `tools/variants_common.py` СЃРѕРґРµСЂР¶РёС‚ alias РґР»СЏ РѕР±СЂР°С‚РЅРѕР№ СЃРѕРІРјРµСЃС‚РёРјРѕСЃС‚Рё СЃС‚Р°СЂС‹С… РёРјРµРЅ РјР°СЃРѕРє, РїСЂРё СЌС‚РѕРј РєР°РЅРѕРЅРёС‡РµСЃРєРёРµ РёРјРµРЅР° РѕСЃС‚Р°СЋС‚СЃСЏ РѕСЃРЅРѕРІРЅС‹РјРё.
- `legasy/` РЅРµ РІС…РѕРґРёС‚ РІ Р°РєС‚РёРІРЅСѓСЋ РѕР±Р»Р°СЃС‚СЊ С‚РµСЃС‚РѕРІ.

