# Прод-аудит (`api`, `frontend`, `tools`)

Дата: 2026-02-16  
Цель: оценить текущую архитектуру и зафиксировать безопасный путь интеграции MVP мнемосхемы в прод.

## 1. Анализ по папкам

## `api`
- Основные файлы:
  - `api/engine_app.py` (монолитный API-слой: маппинг + оркестрация симуляции)
  - `api/station_layout.py` (извлечение layout-данных для фронтенда)
  - `api/app.py` (точка входа)
- Ключевые endpoint’ы `engine_app.py`:
  - `/simulate`
  - `/station-layout`
  - `/node-catalog`
  - `/exceptions-config`
  - `/tests` (CRUD)
  - `/defaults`, `/health`
- Сильные стороны:
  - рабочий end-to-end путь от сценария до таймлайна;
  - есть нормализация и обратная совместимость по алиасам;
  - есть отдельный endpoint layout, необходимый для MVP мнемосхемы.
- Риски:
  - чрезмерная концентрация ответственности в одном файле (~900 строк);
  - сложнее тестировать endpoint-логику отдельно от маппинга;
  - сложнее безопасно развивать API-контракт для нескольких фронтендов.

## `frontend`
- Основные JS-модули:
  - `schema-mvp.js` (парсинг + рендер + визуальные состояния + controls)
  - `scenario.js` (таблица сценария и редактирование)
  - `timeline-render.js` (рендер таймлайна и фильтры)
  - `app.js` (связка приложения и запуск симуляции)
  - `options.js`, `tabs.js`, `exceptions-config.js` (конфигурационные UI-блоки)
- Сильные стороны:
  - MVP мнемосхемы уже интерактивен и пригоден для тестов;
  - сценарий и таймлайн находятся в едином рабочем процессе;
  - загрузка layout с backend уже интегрирована.
- Риски:
  - `schema-mvp.js` слишком большой и смешивает несколько слоев;
  - высокая связность через глобальные `window.*` контракты;
  - недостаточно автотестов на пограничные случаи топологии.

## `tools`
- Ядро:
  - `tools/core/detectors_engine.py`
  - `tools/core/sim_core.py`
  - `tools/core/variants_common.py`
- Доменная логика:
  - `tools/variants/lz/*`, `tools/variants/ls/*`
  - `tools/exceptions/*`
- Сильные стороны:
  - явная и настраиваемая модель детекторов;
  - хорошее разделение варианта/масок;
  - поддержка динамической топологии и исключений в контексте симуляции.
- Риски:
  - крупные файлы ядра ухудшают поддерживаемость;
  - смешанные стили имен опций и legacy-алиасы;
  - местами битая кодировка в комментариях/докстрингах варианта.

## 2. Подготовленные документы требований

1. Требования по ЛЗ:
- `tools/variants/lz/README.md`

2. Требования по ЛС:
- `tools/variants/ls/README.md`

3. Требования по исключениям:
- `tools/exceptions/README.md`

Во всех документах:
- краткое назначение папки;
- требования реализации по вариантам/исключениям.

## 3. Проверка кодировок

## Исправлено в этом проходе
1. Очищены битые тексты в активной документации:
- `tools/README.md`
- `tools/docs/AUDIT.md`
- `tools/docs/TECH_DEBT.md`
- `tools/variants/lz/README.md`
- `tools/variants/ls/README.md`
- `tools/exceptions/README.md`

## Осталось (вынесено в техдолг)
1. В ряде variant-файлов остаются битые комментарии/докстринги.
2. Логика не менялась намеренно, чтобы исключить регресс перед MVP-демо.

## 4. Рекомендации по интеграции MVP мнемосхемы в прод

Рекомендуемая стратегия: поэтапная интеграция без поломки текущего интерфейса.

1. Держать MVP-вкладку мнемосхемы под feature-flag на первом этапе.
2. Зафиксировать backend-контракт для:
- `/station-layout`;
- `/simulate` (вход/выход, используемый мнемосхемой).
3. Ввести адаптер состояния во фронтенде:
- преобразование payload таймлайна/сценария в renderer-state в одном месте.
4. Добавить регрессионные тесты для 3 критичных зон:
- подсветка ветви по положению стрелки;
- приоритет цветов занятости/замыкания РЦ;
- фильтрация индикаторов по linked `prev/next`.
5. После стабилизации контракта — декомпозиция крупных файлов.

## 5. Улучшения backend под мнемосхему

1. Вынести нормализацию сценария в отдельный service-модуль.
2. Держать канонизацию имен/ID в одном deterministic-слое.
3. Добавить version field в API-ответы (задел под несколько станций/паков).
4. Добавить детализированные ошибки валидации payload по полям.

## 6. Рекомендации по UI/UX тестирования

1. Сохранить шаго-центричную правую панель: “новый шаг”, “дублировать прошлый”, затем редактирование событий шага.
2. Оставить изолированный скролл правой панели для длинных сценариев.
3. Разделить zoom и выбор объектов, чтобы не конфликтовали клики.
4. Оставить видимым summary шага (временной интервал, длительность, число событий).

## 6.1 Базовое правило арбитража

При одновременном открытии ДС в одном шаге:
1. ЛЗ имеет приоритет над ЛС.
2. Кандидат ЛС помечается как подавленный с явной причиной в timeline/API.
3. Это базовое правило обязательно входит в будущую матрицу приоритетов.

## 7. Кандидаты на рефакторинг

См.:
- `tools/docs/TECH_DEBT.md`

Наибольший эффект:
1. `frontend/static/schema-mvp.js`
2. `api/engine_app.py`
3. `tools/core/detectors_engine.py`
4. `tools/core/sim_core.py`

## 8. Статус готовности MVP

1. Рабочий процесс MVP мнемосхемы функционирует для визуального тестирования станции.
2. В этом проходе логика детекторов не изменялась.
3. База документации пригодна для реализации и handoff.
4. Главный риск на текущем этапе — поддерживаемость, а не текущая функциональность.
