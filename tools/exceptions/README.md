# Требования к исключениям (`tools/exceptions`)

Документ описывает исключения как требования к блокировке формирования ЛЗ/ЛС.

## Единые понятия
- `Контролируемая РЦ` — РЦ текущего детектора.
- `Смежные РЦ` — соседние по текущей топологии.
- `Финальная фаза` — фаза, где `next_phase_id = -1` (момент формирования ДС).
- `Подавление` — удаление флагов `llz_*`/`lls_*` с выставлением служебного `*_suppressed:*`.

## Общие требования
1. Исключения не меняют данные сценария; они влияют только на формирование/сохранение флагов ДС.
2. Проверка исключений выполняется в рамках текущего шага и по таймлайн-окнам времени.
3. Для фазовой интеграции используется `PhaseConfig.abort_exception_keys`.
4. Базовое правило: исключение блокирует формирование на финальной фазе (если явно не задано иное для варианта).
5. При одновременном формировании ЛЗ и ЛС в один и тот же момент времени применяется приоритет `ЛЗ > ЛС`.

---

## Исключения ЛЗ

### `exc_lz_mu_active`
1. Условие активации: `enable_lz_exc_mu = true`.
2. Проверка: активность MU в области `{контролируемая, смежные}` в окне `t_mu`.
3. Действие: блокировать финальную фазу формирования ЛЗ.
4. Флаг подавления: `lz_suppressed:local_mu`.

### `exc_lz_recent_ls`
1. Условие активации: `enable_lz_exc_recent_ls = true`.
2. Проверка: наличие недавней ЛС в окне `t_recent_ls`.
3. Действие: блокировать финальную фазу формирования ЛЗ.
4. Флаг подавления: `lz_suppressed:recent_ls`.

### `exc_lz_dsp_timeout`
1. Условие активации: `enable_lz_exc_dsp = true`.
2. Проверка режима: активен DSP и отключены авто-действия.
3. Проверка времени: занятость контролируемой РЦ длится не менее порога (`t_min_maneuver_v8` или `t_maneuver` из DSP policy).
4. Действие: блокировать формирование только для вариантов, перечисленных в DSP policy (`variants`).
5. Флаг подавления: `lz_suppressed:dsp_autoaction` или `lz_suppressed:dsp_detector_gate` (по месту применения).

---

## Исключения ЛС

### `exc_ls_mu_active`
1. Условие активации: `enable_ls_exc_mu = true`.
2. Проверка: активность MU в области локальных РЦ в окне `t_ls_mu`.
3. Действие: блокировать финальную фазу формирования ЛС.
4. Флаг подавления: `ls_suppressed:local_mu`.

### `exc_ls_after_lz`
1. Условие активации: `enable_ls_exc_after_lz = true`.
2. Проверка: наличие недавней ЛЗ в окне `t_ls_after_lz`.
3. Действие: блокировать финальную фазу формирования ЛС.
4. Флаг подавления: `ls_suppressed:after_lz`.

### `exc_ls_dsp_timeout`
1. Условие активации: `enable_ls_exc_dsp = true`.
2. Проверка режима: активен DSP и отключены авто-действия.
3. Проверка времени: занятость контролируемой РЦ длится не менее `t_ls_dsp`.
4. Действие: блокировать финальную фазу формирования ЛС.
5. Флаг подавления: `ls_suppressed:dsp_autoaction`.

---

## Приоритеты исключений

### Для ЛЗ
1. `exc_lz_mu_active`
2. `exc_lz_recent_ls`
3. `exc_lz_dsp_timeout`

### Для ЛС
1. `exc_ls_mu_active`
2. `exc_ls_after_lz`
3. `exc_ls_dsp_timeout`

Если одновременно подходят несколько исключений одной группы, применяется первое по приоритету.

---

## Одновременное формирование ЛЗ и ЛС
1. Если ЛЗ и ЛС формируются в одно и то же время, сохраняется ЛЗ.
2. ЛС подавляется.
3. Флаги аудита: `ls_suppressed:priority_lz`, `ls_suppressed:priority_lz_same_time`.

---

## Требования к объектному реестру исключений (`exceptions_objects.json`)
1. Поддерживаемые `kind`: `MU`, `NAS`, `CHAS`, `DSP`.
2. `id` обязателен и уникален.
3. `target_rc_ids` задает область действия по РЦ.
4. `active_states` задает активные состояния индикатора; если отсутствует, используется ON-состояние по умолчанию.
5. Активность читается из `ScenarioStep.indicator_states`.

## Требования к DSP policy
1. Поддерживаются секции `default` и `rc_overrides`.
2. Итоговая policy формируется как `default + override`.
3. Основные поля: `enabled`, `mode`, `count_scope`, `variants`, `t_maneuver`.
4. `variants` определяет, к каким вариантам ЛЗ применяется DSP-блокировка.

## Состояния индикаторов (`indicator_states.py`)
1. `INDICATOR_OFF = 3`.
2. `INDICATOR_ON = 6`.
3. Если `active_states` не задан, активным считается `6`.
