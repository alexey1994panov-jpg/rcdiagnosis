# Исключения (`tools/exceptions`)

Папка содержит логику исключений/подавлений для детекторов ЛЗ/ЛС и объектный реестр источников (MU/NAS/CHAS/DSP).

## Состав
- `exceptions_engine.py` — расчет и применение подавлений флагов детекторов.
- `exceptions_objects_registry.py` — загрузка и вычисление активности объектных исключений.
- `exceptions_objects.json` — конфигурация объектов и DSP-политики.
- `indicator_states.py` — канонические состояния индикаторов для объектных исключений.

## Общие правила
1. Исключения применяются после расчета шага детектора.
2. Подавление удаляет активные флаги (`llz_*`, `lls_*`) и добавляет поясняющий `*_suppressed:*` флаг.
3. После подавления обязательно пересчитываются `lz_state` и `lz_variant`.
4. Временные условия считаются по таймлайну (в секундах), а не по количеству шагов.
5. Для фазовых гейтов используется `PhaseConfig.abort_exception_keys`.
6. По договоренности при одновременном формировании действует приоритет: **ЛЗ > ЛС**.

## Исключения ЛЗ

### `exc_lz_mu_active`
- Требует `enable_lz_exc_mu = true`.
- Проверяет активность MU в окне `t_mu` в области `{ctrl, prev, next}`.
- Блокирует формирование ЛЗ (на финальной фазе открытия).

### `exc_lz_recent_ls`
- Требует `enable_lz_exc_recent_ls = true`.
- Срабатывает, если недавно была ЛС в окне `t_recent_ls`.
- Блокирует формирование ЛЗ (на финальной фазе открытия).

### `exc_lz_dsp_timeout`
- Требует `enable_lz_exc_dsp = true`.
- Требует активного DSP и отключенных авто-действий.
- Требует занятости control RC не менее порога времени.
- Применяется централизованно через DSP policy (с выбором вариантов).

## Исключения ЛС

### `exc_ls_mu_active`
- Требует `enable_ls_exc_mu = true`.
- Проверяет MU в окне `t_ls_mu`.
- Блокирует формирование ЛС (на финальной фазе открытия).

### `exc_ls_after_lz`
- Требует `enable_ls_exc_after_lz = true`.
- Срабатывает при недавней ЛЗ в окне `t_ls_after_lz`.
- Блокирует формирование ЛС (на финальной фазе открытия).

### `exc_ls_dsp_timeout`
- Требует `enable_ls_exc_dsp = true`.
- Требует активного DSP и отключенных авто-действий.
- Требует занятости control RC не менее `t_ls_dsp`.
- Блокирует формирование ЛС.

## Приоритеты подавлений
- Для ЛЗ: `MU -> recent LS -> DSP`.
- Для ЛС: `MU -> after LZ -> DSP`.
- Применяется первое совпавшее правило по приоритету.

## Одновременное формирование ЛЗ и ЛС
Если ЛЗ и ЛС формируются в один и тот же момент времени, сохраняется ЛЗ, ЛС подавляется.

Флаги для аудита:
- `ls_suppressed:priority_lz`
- `ls_suppressed:priority_lz_same_time`

## Объектный реестр (`exceptions_objects_registry.py`)
Поддерживаемые `kind`:
- `MU`
- `NAS`
- `CHAS`
- `DSP`

Требования:
1. `id` обязателен и уникален.
2. `target_rc_ids` задает область действия по РЦ.
3. Если `active_states` не задан — используется состояние ON по умолчанию.
4. Активность читается из `ScenarioStep.indicator_states[obj_id]`.

## DSP policy (`exceptions_objects.json`)
Поддерживается:
- `default`
- `rc_overrides`

Эффективная конфигурация формируется как `default + override`.

Типовые поля:
- `enabled`
- `mode`
- `count_scope`
- `variants`
- `t_maneuver`

## Состояния индикаторов (`indicator_states.py`)
- `INDICATOR_OFF = 3`
- `INDICATOR_ON = 6`

Если у объекта не задан `active_states`, активным считается `6`.
