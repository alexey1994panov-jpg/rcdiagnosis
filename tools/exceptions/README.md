# РСЃРєР»СЋС‡РµРЅРёСЏ (`tools/exceptions`)

## РќР°Р·РЅР°С‡РµРЅРёРµ
РџР°РїРєР° СЃРѕРґРµСЂР¶РёС‚ Р»РѕРіРёРєСѓ РёСЃРєР»СЋС‡РµРЅРёР№/РїРѕРґР°РІР»РµРЅРёР№ РґР»СЏ Р›Р—/Р›РЎ, Р° С‚Р°РєР¶Рµ СЂРµРµСЃС‚СЂ РѕР±СЉРµРєС‚РЅС‹С… РёСЃС‚РѕС‡РЅРёРєРѕРІ MU/NAS/CHAS/DSP.

## РЎРѕСЃС‚Р°РІ РїР°РїРєРё
- `exceptions_engine.py`: runtime-РєРѕРЅС‚РµРєСЃС‚ РёСЃРєР»СЋС‡РµРЅРёР№ Рё РїСЂР°РІРёР»Р° РїРѕРґР°РІР»РµРЅРёСЏ.
- `exceptions_objects_registry.py`: Р·Р°РіСЂСѓР·РєР° Рё СЂР°СЃС‡РµС‚ Р°РєС‚РёРІРЅРѕСЃС‚Рё РѕР±СЉРµРєС‚РЅРѕРіРѕ СЂРµРµСЃС‚СЂР°.
- `exceptions_objects.json`: РєРѕРЅС„РёРіСѓСЂР°С†РёСЏ РѕР±СЉРµРєС‚РѕРІ РёСЃРєР»СЋС‡РµРЅРёР№ Рё DSP policy.
- `indicator_states.py`: РєР°РЅРѕРЅРёС‡РµСЃРєРёРµ СЃРѕСЃС‚РѕСЏРЅРёСЏ РёРЅРґРёРєР°С‚РѕСЂРѕРІ РґР»СЏ РѕР±СЉРµРєС‚РЅС‹С… РёСЃРєР»СЋС‡РµРЅРёР№.

## РћР±С‰РёРµ С‚СЂРµР±РѕРІР°РЅРёСЏ СЂРµР°Р»РёР·Р°С†РёРё
1. РСЃРєР»СЋС‡РµРЅРёСЏ РїСЂРёРјРµРЅСЏСЋС‚СЃСЏ РїРѕСЃР»Рµ СЂР°СЃС‡РµС‚Р° РґРµС‚РµРєС‚РѕСЂР° РЅР° С€Р°РіРµ.
2. РџРѕРґР°РІР»РµРЅРёРµ СѓРґР°Р»СЏРµС‚ Р°РєС‚РёРІРЅС‹Рµ С„Р»Р°РіРё РґРµС‚РµРєС‚РѕСЂРѕРІ (`llz_*`, `lls_*`) Рё РґРѕР±Р°РІР»СЏРµС‚ СЏРІРЅС‹Рµ `*_suppressed:*` С„Р»Р°РіРё.
3. РџРѕСЃР»Рµ РїРѕРґР°РІР»РµРЅРёСЏ РѕР±СЏР·Р°С‚РµР»СЊРЅРѕ РїРµСЂРµСЃС‡РёС‚С‹РІР°СЋС‚СЃСЏ `lz_state` Рё `lz_variant`.
4. Р’СЂРµРјРµРЅРЅС‹Рµ РѕРєРЅР° СЃС‡РёС‚Р°СЋС‚СЃСЏ РїРѕ timeline-РёСЃС‚РѕСЂРёРё, Р° РЅРµ РїРѕ РєРѕР»РёС‡РµСЃС‚РІСѓ С€Р°РіРѕРІ.
5. Р¤Р°Р·РѕРІС‹Рµ РіРµР№С‚С‹ РёСЃРєР»СЋС‡РµРЅРёР№ РІРµС€Р°СЋС‚СЃСЏ РЅР° С„РёРЅР°Р»СЊРЅС‹Рµ С„Р°Р·С‹ РѕС‚РєСЂС‹С‚РёСЏ РґРµС‚РµРєС‚РѕСЂРѕРІ (`next_phase_id < 0`) С‡РµСЂРµР· `PhaseConfig.abort_exception_keys`.
6. Р”Р»СЏ `MU` Р±Р»РѕРєРёСЂСѓРµС‚СЃСЏ РёРјРµРЅРЅРѕ РѕС‚РєСЂС‹С‚РёРµ (С„РёРЅР°Р»СЊРЅР°СЏ С„Р°Р·Р°), РїСЂРѕРјРµР¶СѓС‚РѕС‡РЅС‹Рµ С„Р°Р·С‹ РЅРµ Р·Р°РјРѕСЂР°Р¶РёРІР°СЋС‚СЃСЏ.

## РўСЂРµР±РѕРІР°РЅРёСЏ РїРѕ РёСЃРєР»СЋС‡РµРЅРёСЏРј Р›Р—

### `exc_lz_mu_active`
1. РўСЂРµР±СѓРµС‚ `enable_lz_exc_mu = true`.
2. РџСЂРѕРІРµСЂСЏРµС‚ Р°РєС‚РёРІРЅРѕСЃС‚СЊ MU РІ РѕРєРЅРµ `t_mu` РїРѕ РјРЅРѕР¶РµСЃС‚РІСѓ `{ctrl, effective_prev, effective_next}`.
3. РџРѕРґР°РІР»СЏРµС‚ РІСЃРµ `llz_v*`, РґРѕР±Р°РІР»СЏРµС‚ `lz_suppressed:local_mu`.

### `exc_lz_recent_ls`
1. РўСЂРµР±СѓРµС‚ `enable_lz_exc_recent_ls = true`.
2. РџСЂРѕРІРµСЂСЏРµС‚ РЅР°Р»РёС‡РёРµ Р»СЋР±РѕРіРѕ LS-С„Р»Р°РіР° РІ РѕРєРЅРµ `t_recent_ls`.
3. РџРѕРґР°РІР»СЏРµС‚ РІСЃРµ `llz_v*`, РґРѕР±Р°РІР»СЏРµС‚ `lz_suppressed:recent_ls`.

### `exc_lz_dsp_timeout`
1. РўСЂРµР±СѓРµС‚ `enable_lz_exc_dsp = true`.
2. РўСЂРµР±СѓРµС‚ Р°РєС‚РёРІРЅРѕРіРѕ СЂРµР¶РёРјР° DSP (`dispatcher_control_state == 4`).
3. РўСЂРµР±СѓРµС‚ РѕС‚РєР»СЋС‡РµРЅРЅС‹С… Р°РІС‚Рѕ-РґРµР№СЃС‚РІРёР№ (`0` РёР»Рё `3`).
4. РўСЂРµР±СѓРµС‚ РЅРµРїСЂРµСЂС‹РІРЅРѕР№ Р·Р°РЅСЏС‚РѕСЃС‚Рё control RC РЅРµ РјРµРЅРµРµ `t_min_maneuver_v8`.
5. Р’ С‚РµРєСѓС‰РµР№ СЂРµР°Р»РёР·Р°С†РёРё РїРѕРґР°РІР»СЏСЋС‚СЃСЏ `llz_v8*`.

## РўСЂРµР±РѕРІР°РЅРёСЏ РїРѕ РёСЃРєР»СЋС‡РµРЅРёСЏРј Р›РЎ

### `exc_ls_mu_active`
1. РўСЂРµР±СѓРµС‚ `enable_ls_exc_mu = true`.
2. РџСЂРѕРІРµСЂСЏРµС‚ MU-Р°РєС‚РёРІРЅРѕСЃС‚СЊ РІ РѕРєРЅРµ `t_ls_mu` РїРѕ Р»РѕРєР°Р»СЊРЅРѕРјСѓ РЅР°Р±РѕСЂСѓ Р Р¦.
3. РџРѕРґР°РІР»СЏРµС‚ РІСЃРµ `lls_*`, РґРѕР±Р°РІР»СЏРµС‚ `ls_suppressed:local_mu`.

### `exc_ls_after_lz`
1. РўСЂРµР±СѓРµС‚ `enable_ls_exc_after_lz = true`.
2. РџСЂРѕРІРµСЂСЏРµС‚ РЅР°Р»РёС‡РёРµ LZ-С„Р»Р°РіРѕРІ РІ РѕРєРЅРµ `t_ls_after_lz`.
3. РџРѕРґР°РІР»СЏРµС‚ РІСЃРµ `lls_*`, РґРѕР±Р°РІР»СЏРµС‚ `ls_suppressed:after_lz`.

### `exc_ls_dsp_timeout`
1. РўСЂРµР±СѓРµС‚ `enable_ls_exc_dsp = true`.
2. РўСЂРµР±СѓРµС‚ Р°РєС‚РёРІРЅРѕРіРѕ DSP Рё РѕС‚РєР»СЋС‡РµРЅРЅС‹С… Р°РІС‚Рѕ-РґРµР№СЃС‚РІРёР№.
3. РўСЂРµР±СѓРµС‚ Р·Р°РЅСЏС‚РѕСЃС‚Рё control RC РІ С‚РµС‡РµРЅРёРµ `t_ls_dsp`.
4. РџРѕРґР°РІР»СЏРµС‚ РІСЃРµ `lls_*`, РґРѕР±Р°РІР»СЏРµС‚ `ls_suppressed:dsp_autoaction`.

## РџСЂРёРѕСЂРёС‚РµС‚ РїРѕРґР°РІР»РµРЅРёР№
1. Р”Р»СЏ Р›Р—: MU -> recent LS -> DSP timeout.
2. Р”Р»СЏ Р›РЎ: MU -> after LZ -> DSP timeout.
3. РќР° С€Р°РіРµ РїСЂРёРјРµРЅСЏРµС‚СЃСЏ РїРµСЂРІРѕРµ СЃРѕРІРїР°РІС€РµРµ РїСЂР°РІРёР»Рѕ РІ С†РµРїРѕС‡РєРµ РїСЂРёРѕСЂРёС‚РµС‚Р°.

## РђСЂР±РёС‚СЂР°Р¶ РѕРґРЅРѕРІСЂРµРјРµРЅРЅРѕРіРѕ С„РѕСЂРјРёСЂРѕРІР°РЅРёСЏ
1. Р•СЃР»Рё `Р›Р—` Рё `Р›РЎ` С„РѕСЂРјРёСЂСѓСЋС‚СЃСЏ РІ РѕРґРёРЅ Рё С‚РѕС‚ Р¶Рµ Р°Р±СЃРѕР»СЋС‚РЅС‹Р№ РјРѕРјРµРЅС‚ РІСЂРµРјРµРЅРё `t`, РїСЂРёРјРµРЅСЏРµС‚СЃСЏ РїСЂРёРѕСЂРёС‚РµС‚ `Р›Р— > Р›РЎ`.
2. РЎС†РµРЅР°СЂРёР№ В«РѕРґРЅРѕРІСЂРµРјРµРЅРЅРѕСЃС‚СЊ РІ РѕРґРЅРѕРј СЂРµР·СѓР»СЊС‚Р°С‚Рµ С€Р°РіР°В» С‚Р°РєР¶Рµ РїРѕРґРїР°РґР°РµС‚ РїРѕРґ СЌС‚Рѕ РїСЂР°РІРёР»Рѕ.
3. РџСЂРё РїРѕРґР°РІР»РµРЅРёРё С„Р»Р°РіРё `lls_*` СѓРґР°Р»СЏСЋС‚СЃСЏ, РІ `flags` РґРѕР±Р°РІР»СЏРµС‚СЃСЏ:
   - `ls_suppressed:priority_lz` (РѕРґРёРЅ СЂРµР·СѓР»СЊС‚Р°С‚ С€Р°РіР°),
   - РёР»Рё `ls_suppressed:priority_lz_same_time` (СЃРѕРІРїР°РґРµРЅРёРµ `t` РјРµР¶РґСѓ С€Р°РіР°РјРё).
4. Р”Р»СЏ РєР°Р¶РґРѕРіРѕ РїРѕРґР°РІР»РµРЅРЅРѕРіРѕ РІР°СЂРёР°РЅС‚Р° Р›РЎ РґРѕР±Р°РІР»СЏРµС‚СЃСЏ `ls_suppressed:vN:*`.
5. РџРѕСЃР»Рµ Р°СЂР±РёС‚СЂР°Р¶Р° `lz_state/lz_variant` РїРµСЂРµСЃС‡РёС‚С‹РІР°СЋС‚СЃСЏ РїРѕ РѕСЃС‚Р°РІС€РёРјСЃСЏ С„Р»Р°РіР°Рј.

## РўСЂРµР±РѕРІР°РЅРёСЏ Рє РѕР±СЉРµРєС‚РЅРѕРјСѓ СЂРµРµСЃС‚СЂСѓ (`exceptions_objects_registry.py`)
1. РџРѕРґРґРµСЂР¶РёРІР°РµРјС‹Рµ `kind`: `MU`, `NAS`, `CHAS`, `DSP`.
2. `id` РѕР±СЏР·Р°С‚РµР»РµРЅ Рё РґРѕР»Р¶РµРЅ Р±С‹С‚СЊ СѓРЅРёРєР°Р»РµРЅ.
3. `target_rc_ids` Р·Р°РґР°СЋС‚ РѕР±Р»Р°СЃС‚СЊ РґРµР№СЃС‚РІРёСЏ РїРѕ Р Р¦ (`DSP` РіР»РѕР±Р°Р»СЊРЅС‹Р№ РїРѕ РєРѕРЅС‚СЂР°РєС‚Сѓ).
4. Р•СЃР»Рё `active_states` РЅРµ Р·Р°РґР°РЅ, РёСЃРїРѕР»СЊР·СѓРµС‚СЃСЏ СЃРѕСЃС‚РѕСЏРЅРёРµ РёРЅРґРёРєР°С‚РѕСЂР° ON РїРѕ СѓРјРѕР»С‡Р°РЅРёСЋ.
5. РђРєС‚РёРІРЅРѕСЃС‚СЊ С‡РёС‚Р°РµС‚СЃСЏ РёР· `ScenarioStep.indicator_states[obj_id]`.

## РўСЂРµР±РѕРІР°РЅРёСЏ Рє DSP policy (`exceptions_objects.json`)
1. РџРѕРґРґРµСЂР¶РёРІР°СЋС‚СЃСЏ `default` Рё per-RC РїРµСЂРµРѕРїСЂРµРґРµР»РµРЅРёСЏ (`rc_overrides`).
2. Р­С„С„РµРєС‚РёРІРЅР°СЏ policy С„РѕСЂРјРёСЂСѓРµС‚СЃСЏ РєР°Рє merge: `default` Р·Р°С‚РµРј override.
3. РћС‚СЃСѓС‚СЃС‚РІСѓСЋС‰РёРµ РїРѕР»СЏ Р·Р°РїРѕР»РЅСЏСЋС‚СЃСЏ fallback-Р·РЅР°С‡РµРЅРёСЏРјРё РёР· detector config.
4. РўРёРїРѕРІС‹Рµ РїРѕР»СЏ: `enabled`, `mode`, `count_scope`, `variants`, `t_maneuver`.

## РўСЂРµР±РѕРІР°РЅРёСЏ Рє СЃРѕСЃС‚РѕСЏРЅРёСЏРј РёРЅРґРёРєР°С‚РѕСЂРѕРІ (`indicator_states.py`)
1. `INDICATOR_OFF = 3`
2. `INDICATOR_ON = 6`
3. Р•СЃР»Рё Сѓ РѕР±СЉРµРєС‚Р° РЅРµ Р·Р°РґР°РЅ `active_states`, Р°РєС‚РёРІРЅС‹Рј СЃС‡РёС‚Р°РµС‚СЃСЏ СЃРѕСЃС‚РѕСЏРЅРёРµ `6`.


## Уточнение по фазовой логике DSP
1. Используется единый ключ исключения: exc_lz_dsp_timeout.
2. Ключ exc_lz8_dsp_timeout больше не используется.
3. Для ЛЗ это исключение применяется на всех фазах формирования, не только на фазе открытия.

