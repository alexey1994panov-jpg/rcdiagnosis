# Требования к вариантам ЛС (`tools/variants/ls`)

Документ описывает варианты ЛС как набор типовых фаз.

## Единые понятия
- `Контролируемая РЦ` — РЦ, на которой работает детектор.
- `Смежные РЦ` — соседние по текущей топологии РЦ (`prev`/`next`).
<<<<<<< HEAD
- `Формирование ситуации` — переход в активное состояние ЛС на финальной фазе (`next_phase_id = -1`).
- `Завершение` — закрытие ЛС по правилу завершения варианта.
=======
- `Формирование ситуации` — переход в активное состояние ЛЗ на финальной фазе (`next_phase_id = -1`).
- `Завершение` — закрытие ЛЗ по правилу завершения варианта.

## Эффективная топология (кратко)
- На каждом шаге для контролируемой РЦ вычисляются `effective_prev_rc` и `effective_next_rc` с учетом положений стрелок.
- Если связи в сторону нет, выставляется NC-флаг (`prev_nc`/`next_nc`) и соответствующая смежная считается отсутствующей.
- Поэтому маски проверяются не по статической схеме, а по текущей (эффективной) топологии шага.
- Подробно: `tools/core/topology_manager.py`, `tools/core/sim_step_runner.py`, `tools/core/base_detector.py`.

## Общие требования
1. Все фазы оцениваются по времени в секундах (`>=` заданного порога).
2. Маски проверяются по состояниям контролируемой и смежных РЦ на текущем шаге.
3. Для вариантов с ветками (`BaseVariantWrapper`) формирование выполняется при выполнении любой валидной ветки.
4. Для всех ЛЗ завершение выполняется по `FREE_TIME`: контролируемая РЦ свободна непрерывно не менее `tkon_*`.

---

>>>>>>> 813a90f63323b53db62732e86e529a75889acd6f

## Эффективная топология (кратко)
- На каждом шаге для контролируемой РЦ вычисляются `effective_prev_rc` и `effective_next_rc` с учетом положений стрелок.
- Если связи в сторону нет, выставляется NC-флаг (`prev_nc`/`next_nc`) и соответствующая смежная считается отсутствующей.
- Поэтому маски проверяются не по статической схеме, а по текущей (эффективной) топологии шага.
- Подробно: `tools/core/topology_manager.py`, `tools/core/sim_step_runner.py`, `tools/core/base_detector.py`.

## Общие требования
1. Все фазы оцениваются по времени в секундах (`>=` заданного порога).
2. Маски проверяются по состояниям контролируемой и смежных РЦ на текущем шаге.
3. Для вариантов с ветками (`BaseVariantWrapper`) формирование выполняется при выполнении любой валидной ветки.
4. Завершение может быть двух типов:
   - `FREE_TIME` — контролируемая РЦ свободна непрерывно не менее `tkon_*`.
   - `OCCUPIED_TIME` — контролируемая РЦ занята непрерывно не менее `tkon_*`.

---

### LS1 (`variant_ls1_lz_factory.py`)
<<<<<<< HEAD
1. Фаза 1: контролируемая занята, обе смежные свободны (маска `010`) `>= ts01_ls1`.
2. Фаза 2: контролируемая и обе смежные свободны (маска `000`) `>= tlz_ls1` — формирование ситуации.
3. Завершение: контролируемая занята `>= tkon_ls1` (`OCCUPIED_TIME`).
4. Смежные РЦ: обязательны обе (`BOTH`).
=======
1. Обратный паттерн к LZ1.
2. Фаза: `010` в течение >=`ts01_ls1`
3. Фаза: `000` в течение  >=`tlz_ls1` - форимрование ситуации
3. Завершение: при занятии  контролируемой >= `tkon_ls1`.
4. Требование к соседям: `BOTH`.
>>>>>>> 813a90f63323b53db62732e86e529a75889acd6f

### LS2 (`variant_ls2_lz_factory.py`)
Вариант имеет две независимые ветки.

Ветка `prev`:
1. Фаза 1: предыдущая смежная и контролируемая заняты, следующая смежная свободна (маска `110`) `>= ts01_ls2`.
2. Фаза 2: предыдущая смежная занята, контролируемая и следующая свободны (маска `100`) `>= tlz_ls2`.
3. Фаза 3: предыдущая смежная и контролируемая заняты, следующая смежная свободна (маска `110`) `>= ts02_ls2` — формирование ситуации.

Ветка `next`:
1. Фаза 1: следующая смежная и контролируемая заняты, предыдущая смежная свободна (маска `011`) `>= ts01_ls2`.
2. Фаза 2: следующая смежная занята, контролируемая и предыдущая свободны (маска `001`) `>= tlz_ls2`.
3. Фаза 3: следующая смежная и контролируемая заняты, предыдущая смежная свободна (маска `011`) `>= ts02_ls2` — формирование ситуации.

Общие требования:
1. Завершение: контролируемая занята `>= tkon_ls2` (`OCCUPIED_TIME`).
2. Смежные РЦ: обязательны обе (`BOTH`).

### LS4 (`variant_ls4_lz_factory.py`)
Оконный вариант с тремя фазами. Подразумевает "промаргивание" свободной РЦ между двумя состояниями полной занятости.

1. Фаза 1: контролируемая и обе смежные заняты (маска `111`) `>= ts01_ls4`.
2. Фаза 2: контролируемая свободна, обе смежные заняты (маска `101`) в окне `tlz01_ls4 <= t <= tlz02_ls4`.
3. Фаза 3: контролируемая и обе смежные заняты (маска `111`) `>= ts02_ls4` — формирование ситуации.
4. Завершение: контролируемая занята `>= tkon_ls4` (`OCCUPIED_TIME`).
5. Смежные РЦ: обязательны обе (`BOTH`).

### LS5 (`variant_ls5_lz_factory.py`)
<<<<<<< HEAD
Вариант имеет две ветки и использует замкнутость (замыкание в маршруте) РЦ. Поддерживается только для `can_lock=true`.

Ветка `prev`:
1. Фаза 1: предыдущая смежная и контролируемая заняты и замкнуты, следующая смежная свободна и замкнута (маска `RC_1L_0L_0L`) `>= ts01_ls5`.
2. Фаза 2: предыдущая смежная, контролируемая и следующая смежная заняты и замкнуты (маска `RC_1L_0L_1L`) `>= tlz_ls5` — формирование ситуации.

Ветка `next`:
1. Фаза 1: следующая смежная и контролируемая заняты и замкнуты, предыдущая смежная свободна и замкнута (маска `RC_0L_0L_1L`) `>= ts01_ls5`.
2. Фаза 2: предыдущая смежная, контролируемая и следующая смежная заняты и замкнуты (маска `RC_1L_0L_1L`) `>= tlz_ls5` — формирование ситуации.

Общие требования:
1. Завершение: контролируемая занята `>= tkon_ls5` (`OCCUPIED_TIME`).
2. Смежные РЦ: обязательны обе (`BOTH`).

### LS6 (`variant_ls6_lz_factory.py`)
Вариант имеет две направленные ветки (`6.1` и `6.2`), опирается на NC-флаги топологии и учитывает открытый сигнал.

Ветка `6.1` (`prev_nc`):
1. Фаза 1: `prev_nc=true`, контролируемая свободна и замкнута, противоположная (next) смежная свободна и замкнута, сигнал открыт (маска `RC_N_0L_0L_SIG_1`) `>= ts01_ls6`.
2. Фаза 2: `prev_nc=true`, контролируемая свободна и замкнута, противоположная смежная занята и замкнута, сигнал открыт (маска `RC_N_0L_1L_SIG_1`) `>= tlz_ls6` — формирование ситуации.

Ветка `6.2` (`next_nc`):
1. Фаза 1: `next_nc=true`, контролируемая свободна и замкнута, противоположная (prev) смежная свободна и замкнута, сигнал открыт (маска `RC_0L_0L_N_SIG_1`) `>= ts01_ls6`.
2. Фаза 2: `next_nc=true`, контролируемая свободна и замкнута, противоположная смежная занята и замкнута, сигнал открыт (маска `RC_1L_0L_N_SIG_1`) `>= tlz_ls6` — формирование ситуации.

Общие требования:
1. Завершение: контролируемая занята `>= tkon_ls6` (`OCCUPIED_TIME`).
2. Смежные РЦ: обязательна одна NC-сторона (`ONE_NC`).
=======
1. Двухветочный lock-зависимый детектор.
2. Фаза 1: одна смежная РЦ занята+замкнута, control свободна+замкнута, вторая смежная замкнута
3. Фаза 2 `обе смежные заняты+замкнуты` и `control свободна+замкнута`
4. Завершение: `OCCUPIED_TIME`, `tkon_ls5`.
5. Требование к соседям: `BOTH`.

### LS6 (`variant_ls6_lz_factory.py`)
1. NC-ориентированный (одна не контролируется) детектор с двумя ветками (6.1 и 6.2).
2. Фаза 1 : контролируемая замкнута, смежная замкнута, второая смежная NC (не контролируется), светофор на контролируемую открыт
3. Фаза 2 : контролируемая  замкнута, смежная занята, второая смежная NC (не контролируется), светофор на контролируемую не важен
4. Завершение: `OCCUPIED_TIME`, `tkon_ls6`.
5. Требование к соседям: `ONE_NC`.
>>>>>>> 813a90f63323b53db62732e86e529a75889acd6f

### LS9 (`variant_ls9_lz_factory.py`)
1. Фаза 1: контролируемая занята (маска `RC_1`) `>= ts01_ls9`.
2. Фаза 2: контролируемая свободна (маска `RC_0`) `>= tlz_ls9`.
3. Фаза 3: контролируемая занята (маска `RC_1`) `>= tlz_ls9` — формирование ситуации.
4. Завершение: контролируемая занята `>= tkon_ls9` (`OCCUPIED_TIME`).
5. Смежные РЦ: не используются (`ONLY_CTRL`).
