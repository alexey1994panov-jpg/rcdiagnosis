# Варианты ЛС (`tools/variants/ls`)

## Назначение
Папка содержит реализации детекторов ЛС (логическая ложная свободность) для вариантов LS1, LS2, LS4, LS5, LS6, LS9.

## Единые понятия
- `Контролируемая РЦ` — РЦ, на которой работает детектор.
- `Смежные РЦ` — соседние по текущей топологии РЦ (`prev`/`next`).
- `Формирование ситуации` — переход в активное состояние ЛЗ на финальной фазе (`next_phase_id = -1`).
- `Завершение` — закрытие ЛЗ по правилу завершения варианта.

## Эффективная топология (кратко)
- На каждом шаге для контролируемой РЦ вычисляются `effective_prev_rc` и `effective_next_rc` с учетом положений стрелок.
- Если связи в сторону нет, выставляется NC-флаг (`prev_nc`/`next_nc`) и соответствующая смежная считается отсутствующей.
- Поэтому маски проверяются не по статической схеме, а по текущей (эффективной) топологии шага.
- Подробно: `tools/core/topology_manager.py`, `tools/core/sim_step_runner.py`, `tools/core/base_detector.py`.

## Общие требования
1. Все фазы оцениваются по времени в секундах (`>=` заданного порога).
2. Маски проверяются по состояниям контролируемой и смежных РЦ на текущем шаге.
3. Для вариантов с ветками (`BaseVariantWrapper`) формирование выполняется при выполнении любой валидной ветки.
4. Для всех ЛЗ завершение выполняется по `FREE_TIME`: контролируемая РЦ свободна непрерывно не менее `tkon_*`.

---


## Требования по вариантам

### LS1 (`variant_ls1_lz_factory.py`)
1. Обратный паттерн к LZ1.
2. Фаза: `010` в течение >=`ts01_ls1`
3. Фаза: `000` в течение  >=`tlz_ls1` - форимрование ситуации
3. Завершение: при занятии  контролируемой >= `tkon_ls1`.
4. Требование к соседям: `BOTH`.

### LS2 (`variant_ls2_lz_factory.py`)
1. Две ветки (`prev`, `next`) с независимыми фазовыми таймерами.
2. Ветка `prev`: `110 -> 100 -> 110`.
3. Ветка `next`: `011 -> 001 -> 011`.
4. Завершение: `FREE_TIME`, `tkon_ls2`.
5. Требование к соседям: `BOTH`.

### LS4 (`variant_ls4_lz_factory.py`)
1. Специализированный оконный детектор (`LS4WindowDetector`).
2. Фаза 1: `111` не менее `ts01_ls4`.
3. Фаза 2: `101` в окне `tlz01_ls4 <= t <= tlz02_ls4`.
4. Фаза 3: `111` в течение `ts02_ls4`, затем открытие.
5. Завершение: `ctrl occupied` в течение `tkon_ls4`.

### LS5 (`variant_ls5_lz_factory.py`)
1. Двухветочный lock-зависимый детектор.
2. Фаза 1: одна смежная РЦ занята+замкнута, control свободна+замкнута, вторая смежная замкнута
3. Фаза 2 `обе смежные заняты+замкнуты` и `control свободна+замкнута`
4. Завершение: `OCCUPIED_TIME`, `tkon_ls5`.
5. Требование к соседям: `BOTH`.

### LS6 (`variant_ls6_lz_factory.py`)
1. NC-ориентированный (одна не контролируется) детектор с двумя ветками (6.1 и 6.2).
2. Фаза 1 : контролируемая замкнута, смежная замкнута, второая смежная NC (не контролируется), светофор на контролируемую открыт
3. Фаза 2 : контролируемая  замкнута, смежная занята, второая смежная NC (не контролируется), светофор на контролируемую не важен
4. Завершение: `OCCUPIED_TIME`, `tkon_ls6`.
5. Требование к соседям: `ONE_NC`.

### LS9 (`variant_ls9_lz_factory.py`)
1. Control-centric паттерн: occupied -> free -> occupied.
2. Использует `ts01_ls9`, `tlz_ls9`.
3. Завершение: `FREE_TIME`, `tkon_ls9`.
4. Требование к соседям: `ONLY_CTRL`.
