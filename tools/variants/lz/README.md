# Требования к вариантам ЛЗ (`tools/variants/lz`)

Документ описывает варианты ЛЗ как набор типовых фаз.

## Единые понятия
- `Контролируемая РЦ` — РЦ, на которой работает детектор.
- `Смежные РЦ` — соседние по текущей топологии РЦ (`prev`/`next`).
- `Формирование ситуации` — переход в активное состояние ЛЗ на финальной фазе (`next_phase_id = -1`).
- `Завершение` — закрытие ЛЗ по правилу завершения варианта.

## Эффективная топология (кратко)
- На каждом шаге для контролируемой РЦ вычисляются `effective_prev_rc` и `effective_next_rc` с учетом положений стрелок.
- Если связи в сторону нет, выставляется NC-флаг (`prev_nc`/`next_nc`) и соответствующая смежная считается отсутствующей.
- Поэтому маски проверяются не по статической схеме, а по текущей (эффективной) топологии шага.
- Подробно: `tools/core/topology_manager.py`, `tools/core/sim_step_runner.py`, `tools/core/base_detector.py`.

## Общие требования
1. Все фазы оцениваются по времени в секундах (`>=` заданного порога).
2. Маски проверяются по состояниям контролируемой и смежных РЦ на текущем шаге.
3. Для вариантов с ветками (`BaseVariantWrapper`) формирование выполняется при выполнении любой валидной ветки.
4. Для всех ЛЗ завершение выполняется по `FREE_TIME`: контролируемая РЦ свободна непрерывно не менее `tkon_*`.

---

### LZ1 (`variant1_lz_factory.py`)
1. Фаза 1: контролируемая и обе смежные свободны (маска `000`) `>= ts01_lz1`.
2. Фаза 2: контролируемая занята, обе смежные свободны (маска `010`) `>= tlz_lz1` — формирование ситуации.
3. Завершение: контролируемая свободна `>= tkon_lz1`.
4. Смежные РЦ: обязательны обе (`BOTH`).

### LZ2 (`variant2_lz_factory.py`)
Вариант имеет две независимые ветки.

Ветка `prev`:
1. Фаза 1: предыдущая смежная занята, контролируемая и следующая смежная свободны (маска `100`) `>= ts01_lz2`.
2. Фаза 2: предыдущая смежная и контролируемая заняты, следующая смежная свободна (маска `110`) `>= tlz_lz2`.
3. Фаза 3: предыдущая смежная занята, контролируемая и следующая свободны, либо все три свободны (маска `100|000`) `>= ts02_lz2` — формирование ситуации.

Ветка `next`:
1. Фаза 1: следующая смежная занята, контролируемая и предыдущая смежная свободны (маска `001`) `>= ts01_lz2`.
2. Фаза 2: следующая смежная и контролируемая заняты, предыдущая смежная свободна (маска `011`) `>= tlz_lz2`.
3. Фаза 3: следующая смежная занята, контролируемая и предыдущая свободны, либо все три свободны (маска `001|000`) `>= ts02_lz2` — формирование ситуации.

Общие требования:
1. Завершение: контролируемая свободна `>= tkon_lz2`.
2. Смежные РЦ: обязательны обе (`BOTH`).

### LZ3 (`variant3_lz_factory.py`)
1. Фаза 1: обе смежные заняты, контролируемая свободна (маска `101`) `>= ts01_lz3`.
2. Фаза 2: контролируемая и обе смежные заняты (маска `111`) `>= tlz_lz3`.
3. Фаза 3: обе смежные заняты, контролируемая свободна (маска `101`) `>= ts02_lz3` — формирование ситуации.
4. Завершение: контролируемая свободна `>= tkon_lz3`.
5. Смежные РЦ: обязательны обе (`BOTH`).

### LZ4 (`variant4_lz_factory.py`)
Вариант имеет две NC-ветки и учитывает закрытый сигнал.

Ветка `PrevNC`:
1. Фаза 1: `prev_nc=true`, контролируемая свободна, сигнал `prev->ctrl` закрыт (маска `RC_N_0_0_SIG_0`) `>= ts01_lz4`.
2. Фаза 2: `prev_nc=true`, контролируемая занята, сигнал `prev->ctrl` закрыт (маска `RC_N_1_0_SIG_0`) `>= tlz_lz4` — формирование ситуации.

Ветка `NextNC`:
1. Фаза 1: `next_nc=true`, контролируемая свободна, сигнал `ctrl->next` закрыт (маска `RC_0_0_N_SIG_0`) `>= ts01_lz4`.
2. Фаза 2: `next_nc=true`, контролируемая занята, сигнал `ctrl->next` закрыт (маска `RC_0_1_N_SIG_0`) `>= tlz_lz4` — формирование ситуации.

Общие требования:
1. Завершение: контролируемая свободна `>= tkon_lz4`.
2. Смежные РЦ: обязательна одна NC-сторона (`ONE_NC`).

### LZ5 (`variant5_lz_factory.py`)
Важно: вариант работает только для РЦ, у которых в проекте предусмотрено замыкание (`can_lock=true`).

1. Фаза 1: контролируемая свободна и не замкнута (маска `RC_0NL`) `>= ts01_lz5`.
2. Фаза 2: контролируемая занята и не замкнута (маска `RC_1NL`) `>= tlz_lz5` — формирование ситуации.
3. Завершение: контролируемая свободна `>= tkon_lz5`.
4. Смежные РЦ: не используются (`ONLY_CTRL`).

### LZ6 (`variant6_lz_factory.py`)
1. Фаза 1: контролируемая свободна (маска `RC_0`) `>= ts01_lz6`.
2. Фаза 2: контролируемая занята (маска `RC_1`) `>= tlz_lz6` — формирование ситуации.
3. Завершение: контролируемая свободна `>= tkon_lz6`.
4. Смежные РЦ: не используются (`ONLY_CTRL`).

### LZ7 (`variant7_lz_factory.py`)
Вариант имеет три ветки для бесстрелочных/краевых случаев.

Ветка `no_adjacent`:
1. Фаза 1: в эффективной топологии нет смежных РЦ (`prev=None`, `next=None`), контролируемая РЦ свободна (маска `X0X`) `>= ts01_lz7`.
2. Фаза 2: в эффективной топологии нет смежных РЦ (`prev=None`, `next=None`), контролируемая РЦ занята (маска `X1X`) `>= tlz_lz7` — формирование ситуации.

Ветка `no_prev`:
1. Фаза 1: `prev=None`, `next` существует и свободна, контролируемая РЦ свободна (маска `00X`) `>= ts01_lz7`.
2. Фаза 2: `prev=None`, `next` существует и свободна, контролируемая РЦ занята (маска `01X`) `>= tlz_lz7` — формирование ситуации.

Ветка `no_next`:
1. Фаза 1: `next=None`, `prev` существует и свободна, контролируемая РЦ свободна (маска `X00`) `>= ts01_lz7`.
2. Фаза 2: `next=None`, `prev` существует и свободна, контролируемая РЦ занята (маска `X10`) `>= tlz_lz7` — формирование ситуации.

Общие требования:
1. Завершение: контролируемая свободна `>= tkon_lz7`.
2. Смежные РЦ: не обязательны (`NONE`).

### LZ8 (`variant8_lz_factory.py`)
Вариант имеет три ветки и всегда опирается на контролируемую + смежные РЦ.

Ветка `prev`:
1. Фаза 1: контролируемая занята, предыдущая смежная занята, следующая смежная может быть свободной или занятой (маска `110|111`) `>= ts01_lz8`.
2. Фаза 2: контролируемая занята, следующая смежная занята, предыдущая смежная может быть свободной или занятой (маска `011|111`) `>= ts02_lz8`.
3. Фаза 3: контролируемая занята, обе смежные свободны (маска `010`) `>= tlz_lz8` — формирование ситуации.

Ветка `next`:
1. Фаза 1: контролируемая занята, следующая смежная занята, предыдущая смежная может быть свободной или занятой (маска `011|111`) `>= ts01_lz8`.
2. Фаза 2: контролируемая занята и хотя бы одна из смежных свободна (маска `01X|X10`) `>= ts02_lz8`.
3. Фаза 3: контролируемая занята, обе смежные свободны (маска `010`) `>= tlz_lz8` — формирование ситуации.

Ветка `mid`:
1. Фаза 1: контролируемая занята, обе смежные свободны (маска `010`) `>= ts01_lz8`.
2. Фаза 2: контролируемая и следующая смежная заняты, предыдущая свободна (маска `011`) `>= ts02_lz8`.
3. Фаза 3: контролируемая занята, обе смежные свободны (маска `010`) `>= tlz_lz8` — формирование ситуации.

Общие требования:
1. Завершение: контролируемая свободна `>= tkon_lz8`.
2. Смежные РЦ: обязательны обе (`BOTH`).
3. Для фаз применим фазовый гейт DSP-исключения (`exc_lz_dsp_timeout`).

### LZ9 (`variant_lz9_lz_factory.py`)
Специализированный тайминговый вариант (не линейный `BaseDetector`).

1. Фаза 1 (`given`): контролируемая свободна, смежные свободны или NC (маска `RC_0_0L_0`) `>= ts01_lz9`.
2. Фаза 2 (`wait`): фиксируются моменты занятия контролируемой и смежной РЦ (тайминговые условия по маскам `RC_CTRL_1__ADJ_FREE_OR_NC`/`RC_CTRL_0__ADJ_OCC`).
3. Формирование ситуации: если `|t_ctrl_occ - t_adj_occ| <= tlz_lz9`.
4. Если окно `tlz_lz9` истекло до второго события, переход в исходное ожидание.
5. Завершение: контролируемая свободна `>= tkon_lz9`.
6. Смежные РЦ: используются по текущей эффективной топологии.

### LZ10 (`variant_lz10_lz_factory.py`)
Вариант имеет две направленные ветки (`to_next`, `to_prev`) и учитывает сигнал.

1. Фаза 1: контролируемая занята, обе смежные свободны, сигнал открыт (маска `RC_0_1_0_SIG_1`) `>= ts01_lz10`.
2. Фаза 2: контролируемая занята и занята смежная по направлению ветки, противоположная смежная свободна, сигнал открыт (маска `RC_0_1_1_SIG_1`) `>= ts02_lz10`.
3. Фаза 3: условия фазы 2 сохраняются, но сигнал закрыт (маска `RC_0_1_1_SIG_0`) `>= ts03_lz10`.
4. Фаза 4: контролируемая занята, обе смежные свободны, сигнал закрыт (маска `RC_0_1_0_SIG_0`) `>= tlz_lz10` — формирование ситуации.
5. Завершение: контролируемая свободна `>= tkon_lz10`.
6. Смежные РЦ: направление определяется веткой и сигналом.

### LZ11 (`variant_lz11_lz_factory.py`)
1. Фаза 1: контролируемая свободна и оба сигнала к/от контролируемой закрыты (маска `SIG_0_RC_0_SIG_0`) `>= ts01_lz11`.
2. Фаза 2: контролируемая занята и оба сигнала к/от контролируемой закрыты (маска `SIG_0_RC_1_SIG_0`) `>= tlz_lz11` — формирование ситуации.
3. Завершение: контролируемая свободна `>= tkon_lz11`.
4. Смежные РЦ: не используются (`ONLY_CTRL`).

### LZ12 (`variant_lz12_lz_factory.py`)
Вариант имеет две NC-ветки.

Ветка `PrevNC`:
1. Фаза 1: `prev_nc=true`, контролируемая занята и замкнута, следующая смежная свободна и замкнута (маска `RC_N_1_0L`) `>= ts01_lz12`.
2. Фаза 2: `prev_nc=true`, контролируемая занята и замкнута, следующая смежная занята и замкнута (маска `RC_N_1_1L`) `>= ts02_lz12`.
3. Фаза 3: возврат к состоянию фазы 1 (маска `RC_N_1_0L`) `>= tlz_lz12` — формирование ситуации.

Ветка `NextNC`:
1. Фаза 1: `next_nc=true`, контролируемая занята и замкнута, предыдущая смежная свободна и замкнута (маска `RC_L0_1_N`) `>= ts01_lz12`.
2. Фаза 2: `next_nc=true`, контролируемая занята и замкнута, предыдущая смежная занята и замкнута (маска `RC_L1_1_N`) `>= ts02_lz12`.
3. Фаза 3: возврат к состоянию фазы 1 (маска `RC_L0_1_N`) `>= tlz_lz12` — формирование ситуации.

Общие требования:
1. Завершение: контролируемая свободна `>= tkon_lz12`.
2. Смежные РЦ: обязательна одна NC-сторона (`ONE_NC`).

### LZ13 (`variant_lz13_lz_factory.py`)
Вариант имеет две ветки (`prev` и `next`) с учетом закрытого сигнала со смежной на контролируемую.

1. Фаза 1: смежная по ветке свободна и замкнута, контролируемая свободна, сигнал на контролируемую закрыт (маска `RC_0L_0_X_SIG_0`) `>= ts01_lz13`.
2. Фаза 2: смежная по ветке занята, контролируемая свободна, сигнал на контролируемую закрыт (маска `RC_1_X_0_X_SIG_0`) `>= ts02_lz13`.
3. Фаза 3: смежная по ветке занята, контролируемая занята, сигнал на контролируемую закрыт (маска `RC_1_X_1_X_SIG_0`) `>= tlz_lz13` — формирование ситуации.
4. Завершение: контролируемая свободна `>= tkon_lz13`.
5. Смежные РЦ: обязательна одна смежная (`ONE_ADJ`), ветка выбирается по стороне.
